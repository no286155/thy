name: RDP Connection xrdp
on: workflow_dispatch

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:    
    - name: Setup Cloudflared
      run: |
        # wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
        # sudo dpkg -i cloudflared-linux-amd64.deb
        # Add cloudflare gpg key
        sudo mkdir -p --mode=0755 /usr/share/keyrings
        curl -fsSL https://pkg.cloudflare.com/cloudflare-main.gpg | sudo tee /usr/share/keyrings/cloudflare-main.gpg >/dev/null
        
        # Add this repo to your apt repositories
        echo 'deb [signed-by=/usr/share/keyrings/cloudflare-main.gpg] https://pkg.cloudflare.com/cloudflared any main' | sudo tee /etc/apt/sources.list.d/cloudflared.list
        
        # install cloudflared
        sudo apt-get update && sudo apt-get install cloudflared
        
    - name: Setup XRDP
      run: |
        sudo apt-get update
        # sudo apt-get install -y xfce4 xfce4-goodies
        sudo apt-get install xfce4 xfce4-goodies xorg -y
        sudo apt-get install -y xrdp
        # sudo apt-get install -y ubuntu-desktop xrdp
        
        # Fix permissions
        sudo mkdir -p /run/xrdp
        sudo chmod 755 /run/xrdp
        sudo chown root:root /run/xrdp
        sudo touch /run/xrdp/xrdp.pid
        sudo chown root:root /run/xrdp/xrdp.pid
        
        # Configure XRDP
        echo "xfce4-session" | sudo tee /root/.xsession
        sudo cp /root/.xsession /home/runner/.xsession
        sudo chown runner:runner /home/runner/.xsession
        
        # Configure display settings
        sudo sed -i 's/max_bpp=32/max_bpp=16/g' /etc/xrdp/xrdp.ini
        sudo sed -i 's/port=3389/port=3389/g' /etc/xrdp/xrdp.ini
        sudo sed -i 's/crypt_level=high/crypt_level=none/g' /etc/xrdp/xrdp.ini
        sudo sysctl -w net.core.wmem_max=8388608
        sudo sed -i 's/#tcp_send_buffer_bytes=32768/tcp_send_buffer_bytes=4194304/g' /etc/xrdp/xrdp.ini
        
        # Start XRDP
        sudo systemctl enable xrdp
        sudo systemctl start xrdp
        
        # Add permissions
        sudo adduser xrdp ssl-cert
        sudo ufw allow 3389
        sudo ufw reload
        sudo ufw disable

        # Configure XFCE for XRDP
        sudo echo "startxfce4" > /home/runner/.xsession
        sudo chown runner:runner /home/runner/.xsession
        sudo chmod +x /home/runner/.xsession
        
        # Fix XRDP environment issues
        sudo sed -i "/^if \\[ -r \\/etc\\/profile \\ ]; then/a \
        unset DBUS_SESSION_BUS_ADDRESS\nunset XDG_RUNTIME_DIR" /etc/xrdp/startwm.sh
        
        # Disable Wayland (required for XRDP)
        # sudo sed -i "s/^#WaylandEnable=false/WaylandEnable=false/" /etc/gdm3/custom.conf
        
        # Restart services
        # sudo systemctl restart gdm3 || true
        sudo systemctl restart xrdp xrdp-sesman
        
    - name: Setup RDP Password
      run: |
        sudo useradd -m rdpuser
        echo "rdpuser:${{ secrets.RDP_PASSWORD }}" | sudo chpasswd
        sudo usermod -aG sudo rdpuser
        echo "runner:${{ secrets.RDP_PASSWORD }}" | sudo chpasswd
        
    - name: Start Cloudflare Tunnel
      env:
        CLOUDFLARE_TOKEN: ${{ secrets.CLOUDFLARE_TOKEN }}
      run: |
        # # 2 lines after this is working
        sudo cloudflared service install ${CLOUDFLARE_TOKEN}
        sudo systemctl start cloudflared
        # # Check tunnel status
        # cloudflared tunnel list
        # cloudflared tunnel info testing
        # # Verify tunnel logs
        # sudo cloudflared tunnel testing run --url tcp://localhost:3389
        # sudo cloudflared tunnel hloc-dpdns run --url tcp://localhost:3389
        # after this line isnt important
        # wget https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
        # dpkg -i cloudflared-linux-amd64.deb
        echo 'haha'
        echo $USER

    - name: Verify XRDP Status
      run: |
        echo $USER
        sudo sysctl -w net.ipv6.conf.all.disable_ipv6=1
        sudo sysctl -w net.ipv6.conf.default.disable_ipv6=1
        # Check if process is running
        ps aux | grep xrdp
        
        # Check actual port binding
        sudo netstat -tulpn | grep xrdp
        
        # # Check SELinux status (if applicable)
        # sestatus

    - name: Enable Debug Logging
      run: |
        systemctl status xrdp-sesman
        echo "startxfce4" > ~/.xsession
        chmod +x ~/.xsession
        sudo sed -i 's/LogLevel=INFO/LogLevel=DEBUG/g' /etc/xrdp/xrdp.ini
        sudo sed -i 's/EnableSyslog=true/EnableSyslog=true/g' /etc/xrdp/xrdp.ini
        # sudo systemctl restart xrdp
        sudo systemctl restart xrdp xrdp-sesman
        # debug errors::::
        unset SESSION_MANAGER
        unset DBUS_SESSION_BUS_ADDRESS
        # dbus-launch xfce4-session
        # Monitor connections
        sudo sysctl -w net.ipv6.conf.all.disable_ipv6=1
        # sudo tcpdump -i any port 3389 &     
        # sleep 6h
        ls /usr/share/xsessions/
    - name: Keep Alive
      run: |
        # XRDP logs
        sudo tail -f /var/log/xrdp.log
        sudo tail -f /var/log/xrdp-sesman.log
        sleep 6h
name: Ubuntu VNC Setup 02
on: workflow_dispatch

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: System Update
      run: |
        sudo apt-get update
        sudo apt-get upgrade -y
        
    - name: Install Desktop Environment
      run: |
        sudo apt-get install -y xfce4 xfce4-goodies
        sudo apt-get install -y dbus-x11
        
    - name: Install TigerVNC
      run: |
        sudo apt-get install -y tigervnc-standalone-server tigervnc-common
        
    - name: Configure VNC
      env:
        VNC_PASSWORD: ${{ secrets.VNC_PASSWORD }}
      run: |
        mkdir -p ~/.vnc
        
        # Configure VNC startup
        cat > ~/.vnc/xstartup << 'EOL'
        #!/bin/bash
        unset SESSION_MANAGER
        unset DBUS_SESSION_BUS_ADDRESS
        exec startxfce4
        EOL
        chmod +x ~/.vnc/xstartup
        
        # Set VNC password
        echo "${VNC_PASSWORD}" | vncpasswd -f > ~/.vnc/passwd
        chmod 600 ~/.vnc/passwd
        
        # Configure VNC server settings
        cat > ~/.vnc/config << 'EOL'
        geometry=1920x1080
        depth=24
        SecurityTypes=VncAuth,TLSVnc
        localhost=no
        AlwaysShared=1
        EOL
        
    - name: Setup Cloudflared
      run: |
        wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
        sudo dpkg -i cloudflared-linux-amd64.deb
        
    - name: Start VNC Server
      run: |
        # Kill any existing VNC sessions
        vncserver -kill :1 || true
        
        # Start VNC server with specific parameters
        vncserver :1 \
          -geometry 1920x1080 \
          -depth 24 \
          -localhost no \
          -alwaysshared \
          -securitytypes VncAuth,TLSVnc
        
        # Verify VNC server is running and listening on all interfaces
        ps aux | grep vnc
        netstat -tulpn | grep 5901
        
    - name: Start Cloudflare Tunnel
      env:
        CLOUDFLARE_TOKEN: ${{ secrets.CLOUDFLARE_TOKEN }}
      run: |
        sudo cloudflared service install ${CLOUDFLARE_TOKEN}
        sudo systemctl start cloudflared
        sudo systemctl status cloudflared
        
    - name: Connection Info
      run: |
        echo "VNC Server Configuration:"
        echo "------------------------"
        cat ~/.vnc/config
        echo "------------------------"
        echo "Port: 5901"
        echo "Listening on all interfaces"
        ss -tulpn | grep 5901
        
    - name: Keep Alive and Monitor
      run: |
        # Monitor VNC and Cloudflare logs
        tail -f ~/.vnc/*log &
        sudo journalctl -u cloudflared -f &
        sleep 6h

name: Ubuntu VNC Setup
on: workflow_dispatch

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: System Update
      run: |
        sudo apt-get update
        sudo apt-get upgrade -y
        
    - name: Install Desktop Environment
      run: |
        sudo apt-get install -y xfce4 xfce4-goodies
        sudo apt-get install -y dbus-x11 
        
    - name: Install TigerVNC
      run: |
        sudo apt-get install -y tigervnc-standalone-server tigervnc-common
        
    - name: Configure VNC
      env:
        VNC_PASSWORD: ${{ secrets.VNC_PASSWORD }}
      run: |
        # Create VNC directory
        mkdir -p ~/.vnc
        
        # Configure VNC startup
        cat > ~/.vnc/xstartup << 'EOL'
        #!/bin/bash
        unset SESSION_MANAGER
        unset DBUS_SESSION_BUS_ADDRESS
        exec startxfce4
        EOL
        chmod +x ~/.vnc/xstartup
        
        # Set VNC password
        echo "${VNC_PASSWORD}" | vncpasswd -f > ~/.vnc/passwd
        chmod 600 ~/.vnc/passwd
        
    - name: Setup Cloudflared
      run: |
        # Download and install Cloudflared
        wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
        sudo dpkg -i cloudflared-linux-amd64.deb
        
    - name: Configure Cloudflare Tunnel
      env:
        CLOUDFLARE_TOKEN: ${{ secrets.CLOUDFLARE_TOKEN }}
      run: |
        # # Create tunnel configuration directory
        # sudo mkdir -p /etc/cloudflared
        
        # # Configure tunnel
        # sudo bash -c 'cat > /etc/cloudflared/config.yml << EOL
        # tunnel: ${CLOUDFLARE_TOKEN}
        # credentials-file: /etc/cloudflared/cert.json
        # ingress:
        #   - hostname: vnc.yourdomain.com
        #     service: tcp://localhost:5901
        #   - service: http_status:404
        # protocol: tcp
        # EOL'
        
        # Install and start service
        sudo cloudflared service install ${CLOUDFLARE_TOKEN}
        
    - name: Start VNC Server
      run: |
        # Kill any existing VNC sessions
        vncserver -kill :1 || true
        
        # Start VNC server
        vncserver :1 -geometry 1920x1080 -depth 24 -localhost no
        
        # Verify VNC server is running
        ps aux | grep vnc
        netstat -tulpn | grep 5901
        
    - name: Start Cloudflare Tunnel
      run: |
        sudo systemctl start cloudflared
        sudo systemctl status cloudflared
        
    - name: Monitor Logs
      run: |
        echo "VNC Server is running on port 5901"
        echo "Cloudflare tunnel is active"
        echo "Use a VNC client to connect through your Cloudflare tunnel"
        
        # Keep the action running and show logs
        tail -f ~/.vnc/*.log &
        sudo journalctl -u cloudflared -f &
        sleep 6h
